<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat IA Corporativo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Markdown-it para renderizar Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
</head>
<body class="bg-slate-100 h-screen flex flex-col items-center justify-center p-4">

    <div class="w-full max-w-2xl bg-white shadow-xl rounded-xl flex flex-col h-[80vh]">
        <div class="bg-blue-600 p-4 rounded-t-xl text-white font-bold flex justify-between items-center">
            <span>Assistente de Documentos</span>
            <select id="origem" class="text-black text-sm rounded p-1">
                <option value="web">Navegador Web</option>
                <option value="mobile">Aplicativo Mobile</option>
            </select>
        </div>

        <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50"></div>

        <div class="p-4 border-t flex gap-2">
            <input 
                type="text" 
                id="pergunta" 
                placeholder="Digite sua dúvida... (Enter para enviar)" 
                class="flex-1 border p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
            <button onclick="enviarParaN8N()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                Enviar
            </button>
        </div>
    </div>

    <script>
        const meuSessionId = "user_" + Math.random().toString(36).substr(2, 9);
        
        // Instância global do markdown-it
        const md = window.markdownit({
            html: true,
            linkify: true,
            typographer: true,
            breaks: true
        });

        async function enviarParaN8N() {
            const input = document.getElementById('pergunta');
            const chatBox = document.getElementById('chat-box');
            const origem = document.getElementById('origem').value;
            const texto = input.value.trim();

            if (!texto) return;

            // Mostra mensagem do usuário
            chatBox.innerHTML += `
                <div class="flex justify-end">
                    <div class="bg-blue-500 text-white p-3 rounded-lg max-w-[80%] shadow-sm text-xs mb-1">
                        <small class="block opacity-75">Origem: ${origem}</small>
                        ${texto}
                    </div>
                </div>`;
            
            input.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;

            const loadingDiv = document.createElement('div');
            loadingDiv.id = "loading";
            loadingDiv.innerHTML = `<div class="bg-gray-200 p-3 rounded-lg inline-block animate-pulse">IA está pensando...</div>`;
            chatBox.appendChild(loadingDiv);
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const response = await fetch('https://playfivefive.app.n8n.cloud/webhook/d53ed432-f004-4eba-93eb-85c5223fdabe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        chatInput: texto, 
                        sessionId: meuSessionId, 
                        platform: origem,
                        pracaId: "Sorte Cap"
                    })
                });

                const responseText = await response.text();
                
                document.getElementById('loading')?.remove();

                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);

                const htmlResponse = md.render(responseText);

                chatBox.innerHTML += `
                    <div class="flex justify-start">
                        <div class="bg-white border p-3 rounded-lg max-w-[80%] shadow-sm text-gray-800 prose prose-sm max-w-none">
                            <strong>IA:</strong><br>
                            ${htmlResponse}
                        </div>
                    </div>`;
                
                chatBox.scrollTop = chatBox.scrollHeight;

            } catch (error) {
                document.getElementById('loading')?.remove();
                alert("Erro ao conectar com a IA: " + error.message);
            }
        }

        document.getElementById('pergunta').addEventListener('keydown', function(event) {
            // Se pressionar Enter (keyCode 13) e NÃO estiver segurando Shift
            // (Shift + Enter permite quebrar linha, se quiser)
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();         
                enviarParaN8N();                 
            }
        });
    </script>
</body>
</html>