<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat IA Corporativo</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 h-screen flex flex-col items-center justify-center p-4">

    <div class="w-full max-w-2xl bg-white shadow-xl rounded-xl flex flex-col h-[80vh]">
        
        <div class="bg-blue-600 p-4 rounded-t-xl text-white font-bold">
            Assistente de Documentos
        </div>

        <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
            </div>

        <div class="p-4 border-t flex gap-2">
            <input type="text" id="pergunta" placeholder="Digite sua dúvida..." 
                   class="flex-1 border p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="enviarParaN8N()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                Enviar
            </button>
        </div>
    </div>
    <script>
    // 1. Criamos um ID único para a sessão para o n8n não dar erro de "Session ID"
    const meuSessionId = "user_" + Math.random().toString(36).substr(2, 9);

    async function enviarParaN8N() {
        const input = document.getElementById('pergunta');
        const chatBox = document.getElementById('chat-box');
        const texto = input.value.trim();

        if (!texto) return; // Não envia se estiver vazio

        // 2. Mostrar a pergunta do usuário na tela
        chatBox.innerHTML += `
            <div class="flex justify-end">
                <div class="bg-blue-500 text-white p-3 rounded-lg max-w-[80%] shadow-sm">
                    ${texto}
                </div>
            </div>`;
        
        input.value = ''; // Limpa o campo de texto
        chatBox.scrollTop = chatBox.scrollHeight; // Rola o chat para baixo

        // 3. Mostrar indicador de que a IA está "pensando"
        const loadingDiv = document.createElement('div');
    loadingDiv.id = "loading";
    loadingDiv.innerHTML = `<div class="bg-gray-200 p-3 rounded-lg inline-block animate-pulse">IA está pensando...</div>`;
    chatBox.appendChild(loadingDiv);

    try {
        const response = await fetch('https://cainagn.app.n8n.cloud/webhook/d53ed432-f004-4eba-93eb-85c5223fdabe', {  // Mude para webhook (sem -test) se ainda não!
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chatInput: texto, sessionId: meuSessionId })
        });

        const responseText = await response.text();  // Usa text() para capturar raw
        console.log("Status:", response.status, " | Headers:", response.headers.get('Content-Type'));
        console.log("Resposta raw:", responseText || "[VAZIA]");  // Loga se vazio

        if (!response.ok) {
            throw new Error(`HTTP error: ${response.status}`);
        }

        if (!responseText.trim()) {
            throw new Error("Resposta vazia do n8n" + responseText);
        }

  

        // Remove loading só se existir
        const loadingElem = document.getElementById('loading');
        if (loadingElem) loadingElem.remove();
        const data = responseText;
        // Mostra resposta
        chatBox.innerHTML += `
            <div class="flex justify-start">
                <div class="bg-white border p-3 rounded-lg max-w-[80%] shadow-sm text-gray-800">
                    <b>IA:</b><br>${data}
                </div>
            </div>`;
        chatBox.scrollTop = chatBox.scrollHeight;

    } catch (error) {
        const loadingElem = document.getElementById('loading');
        if (loadingElem) loadingElem.remove();
        console.error("Erro:", error);
        alert("Erro ao falar com o n8n: " + error.message);
    }

    }
</script>
</body>
</html>