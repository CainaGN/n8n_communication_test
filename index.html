<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AmandAI - Suporte Play55</title>
    <link rel="icon" href="icone.ico" type="image/x-icon" />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Markdown-it para renderizar Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
  </head>

  <body
    class="bg-slate-100 h-screen flex flex-col items-center justify-center p-4"
  >
    <div
      class="w-full max-w-2xl bg-white shadow-xl rounded-xl flex flex-col h-[80vh]"
    >
      <div
        class="bg-blue-600 p-4 rounded-t-xl text-white font-bold flex justify-between items-center"
      >
        <span>Assistente de Documentos</span>
      </div>

      <div
        id="chat-box"
        class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50"
      ></div>

      <div class="p-4 border-t flex gap-2">
        <input
          type="text"
          id="pergunta"
          placeholder="Digite sua d√∫vida... (Enter para enviar)"
          class="flex-1 border p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
        <button
          id="btn-voice"
          type="button"
          class="bg-gray-200 text-gray-600 px-3 py-2 rounded-lg hover:bg-gray-300 transition flex items-center justify-center"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"
            />
          </svg>
        </button>
        <button
          onclick="enviarParaN8N()"
          class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition"
        >
          Enviar
        </button>
      </div>
    </div>

    <script>
      const meuSessionId = "user_" + Math.random().toString(36).substr(2, 9);

      // Inst√¢ncia global do markdown-it
      const md = window.markdownit({
        html: true,
        linkify: {
          fuzzyLink: false, // desativa links "fuzzy" (sem http/www)
          fuzzyEmail: false, // desativa detec√ß√£o autom√°tica de e-mails
          fuzzyIP: false,
        },
        typographer: true,
        breaks: true,
      });

      // Elementos que vamos controlar
      const inputPergunta = document.getElementById("pergunta");
      const btnEnviar = document.querySelector(
        'button[onclick="enviarParaN8N()"]',
      );

      // Fun√ß√£o auxiliar para bloquear/desbloquear
      function setLoadingState(isLoading) {
        if (isLoading) {
          btnEnviar.disabled = true;
          btnEnviar.textContent = "Enviar";
          btnEnviar.classList.add("opacity-50", "cursor-not-allowed");
          inputPergunta.disabled = true;
        } else {
          btnEnviar.disabled = false;
          btnEnviar.textContent = "Enviar";
          btnEnviar.classList.remove("opacity-50", "cursor-not-allowed");
          inputPergunta.disabled = false;
        }
      }

      async function enviarParaN8N() {
        const chatBox = document.getElementById("chat-box");
        //const origem = document.getElementById('origem').value;
        const texto = inputPergunta.value.trim();

        const urlParams = new URLSearchParams(window.location.search);
        const pracaId = urlParams.get("pracaId") || " ";
        const platform = urlParams.get("platform") || "web/mobile";
        const formulario_contato = "https://wa.me/55556791698264";

        if (!texto) return;

        // Bloqueia imediatamente
        setLoadingState(true);

        // Mostra mensagem do usu√°rio
        chatBox.innerHTML += `
            <div class="flex justify-end">
                <div class="bg-blue-500 text-white p-3 rounded-lg max-w-[80%] shadow-sm text-xs mb-1">
                    ${texto}
                </div>
            </div>`;

        inputPergunta.value = "";
        chatBox.scrollTop = chatBox.scrollHeight;

        const loadingDiv = document.createElement("div");
        loadingDiv.id = "loading";
        loadingDiv.innerHTML = `<div class="bg-gray-200 p-3 rounded-lg inline-block animate-pulse">AmandAI est√° digitando...</div>`;
        chatBox.appendChild(loadingDiv);
        chatBox.scrollTop = chatBox.scrollHeight;

        try {
          const response = await fetch("/api/webhook", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              chatInput: texto,
              sessionId: meuSessionId,
              platform: platform,
              pracaId: pracaId,
              formulario_contato: formulario_contato,
            }),
          });

          const responseText = await response.text();

          document.getElementById("loading")?.remove();

          if (!response.ok) throw new Error(`HTTP error: ${response.status}`);

          const htmlResponse = md.render(responseText);

          chatBox.innerHTML += `
                <div class="flex justify-start">
                    <div class="bg-white border p-3 rounded-lg max-w-[80%] shadow-sm text-gray-800 prose prose-sm max-w-none">
                        <strong>AmandAI:</strong><br>
                        ${htmlResponse}
                    </div>
                </div>`;

          chatBox.scrollTop = chatBox.scrollHeight;
        } catch (error) {
          document.getElementById("loading")?.remove();
          alert("Erro ao conectar com a AmandAI: " + error.message);
          // mostrar mensagem de erro no chat
          chatBox.innerHTML += `
                <div class="flex justify-start">
                    <div class="bg-red-100 border border-red-400 text-red-700 p-3 rounded-lg max-w-[80%]">
                        Erro: ${error.message}
                    </div>
                </div>`;
        } finally {
          // Sempre reabilita no final (sucesso ou erro)
          setLoadingState(false);
        }
      }

      function mostrarBoasVindas() {
        const chatBox = document.getElementById("chat-box");

        const mensagemBoasVindas = `
Ol√°! Sou **AmandAI**, sua assistente virtual! üòä

Posso ajudar voc√™ a encontrar informa√ß√µes e responder d√∫vidas sobre nossa plataforma.

**Digite sua pergunta abaixo** e vamos come√ßar!
    `;

        const htmlMensagem = md.render(mensagemBoasVindas);

        chatBox.innerHTML =
          `
        <div class="flex justify-start">
            <div class="bg-white border p-4 rounded-lg max-w-[80%] shadow-sm text-gray-800 prose prose-sm max-w-none flex items-start gap-4">
                <div class="flex-1">
                    <strong>AmandAI:</strong><br>
                    ${htmlMensagem}
                </div>
                <img 
                    src="avatar_amandai.jpg" 
                    alt="AmandAI" 
                    class="w-32 h-32 rounded-full object-cover border-2 border-blue-300 shadow-md flex-shrink-0"
                >
            </div>
        </div>
    ` + chatBox.innerHTML;

        chatBox.scrollTop = chatBox.scrollHeight;
      }
      // Executa ao carregar a p√°gina
      window.addEventListener("load", () => {
        mostrarBoasVindas();
      });

      // Enter para enviar (mant√©m o comportamento)
      document
        .getElementById("pergunta")
        .addEventListener("keydown", function (event) {
          if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            if (!btnEnviar.disabled) {
              // s√≥ envia se n√£o estiver bloqueado
              enviarParaN8N();
            }
          }
        });
    </script>
    <script>
      (function () {
        function c() {
          var b = a.contentDocument || a.contentWindow.document;
          if (b) {
            var d = b.createElement("script");
            d.innerHTML =
              "window.__CF$cv$params={r:'9c9af0ed48d85417',t:'MTc3MDM4Mzk4Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
            b.getElementsByTagName("head")[0].appendChild(d);
          }
        }
        if (document.body) {
          var a = document.createElement("iframe");
          a.height = 1;
          a.width = 1;
          a.style.position = "absolute";
          a.style.top = 0;
          a.style.left = 0;
          a.style.border = "none";
          a.style.visibility = "hidden";
          document.body.appendChild(a);
          if ("loading" !== document.readyState) c();
          else if (window.addEventListener)
            document.addEventListener("DOMContentLoaded", c);
          else {
            var e = document.onreadystatechange || function () {};
            document.onreadystatechange = function (b) {
              e(b);
              "loading" !== document.readyState &&
                ((document.onreadystatechange = e), c());
            };
          }
        }
      })();
    </script>
  </body>
</html>
